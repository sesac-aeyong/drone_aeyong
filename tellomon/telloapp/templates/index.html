<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Tello Control</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background:#1a1a2e; color:#eee; font-size:20px; overflow-x:hidden;
        }
        .container { max-width:100%; padding:5px; }
        .header {
            background:#16213e; padding:8px 12px; border-radius:6px; margin-bottom:5px;
            display:grid; grid-template-columns:auto 1fr auto; gap:10px; align-items:center;
        }
        h1 { color:#00d9ff; font-size:1.1em; }
        .status { display:flex; gap:5px; font-size:.75em; flex-wrap:wrap; justify-content:center; }
        .status-item { padding:4px 8px; border-radius:4px; font-weight:bold; white-space:nowrap; }
        .connected { background:#10b981; color:#fff; }
        .disconnected { background:#ef4444; color:#fff; }
        .header-controls { display:flex; gap:5px; align-items:center; }
        .header-btn { padding:6px 12px; font-size:.75em; font-weight:bold; border:none; border-radius:4px; cursor:pointer; white-space:nowrap; }
        .header-btn:active { transform:scale(.95); }
        .header-btn:disabled { opacity:.4; cursor:not-allowed; }
        .header-btn-primary { background:#667eea; color:#fff; }
        .header-btn-warning { background:#f59e0b; color:#fff; }

        /* ë¹„ë””ì˜¤ ì˜ì—­ */
        .video-section { background:#16213e; padding:5px; border-radius:6px; margin-bottom:5px; }
        .video-container {
            position:relative; width:100%; background:#000; border-radius:4px; overflow:hidden; cursor:crosshair;
        }
        #videoFeed { width:100%; display:block; }
        .click-target {
            position:absolute; border:3px solid #00d9ff; background:rgba(0,217,255,.1); pointer-events:none; animation:pulse 1s infinite;
        }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.5} }

        /* â–¶ ì‹ ê·œ: ì˜¤ë¥¸ìª½ ìœ„ ê¸°ëŠ¥ í† ê¸€ ë°•ìŠ¤ */
        .feature-panel {
            position:absolute; top:10px; right:10px; z-index:10;
            background:rgba(22,33,62,.85); backdrop-filter:blur(4px);
            border:1px solid #0f3460; border-radius:8px; padding:8px; min-width:210px;
            display:flex; flex-direction:column; gap:6px;
        }
        .feature-title { font-size:.8em; color:#00d9ff; font-weight:bold; display:flex; justify-content:space-between; align-items:center; }
        .feature-row { display:flex; gap:6px; }
        .toggle {
            flex:1; padding:8px 10px; font-size:.8em; font-weight:bold; border:none; border-radius:6px; cursor:pointer;
            background:#0f3460; color:#cbd5e1; transition:transform .15s, background .15s, color .15s, border .15s;
            border:1px solid transparent;
        }
        .toggle:active { transform:scale(.97); }
        .toggle.on { background:#10b981; color:#07281d; border-color:#34d399; }
        .slider-wrap { display:grid; grid-template-columns:1fr auto; align-items:center; gap:8px; }
        .slider-wrap input[type="range"] { width:100%; }
        .slider-badge { font-size:.75em; color:#cbd5e1; background:#0f3460; border:1px solid #203a66; padding:2px 6px; border-radius:4px; }

        .info-text { font-size:.7em; color:#94a3b8; margin:3px 0; padding:5px; background:#0f3460; border-radius:3px; text-align:center; }
        .detections-list { max-height:80px; overflow-y:auto; background:#0f3460; border-radius:4px; padding:5px; margin-top:3px; }
        .detection-item { padding:6px; margin:2px 0; background:#16213e; border-radius:3px; border-left:3px solid #667eea; cursor:pointer; transition:all .2s; font-size:.8em; }
        .detection-item:active { transform:scale(.95); }
        .detection-item.selected { border-left-color:#00d9ff; background:#1a3a52; }
        .detection-item.tracking { border-left-color:#10b981; background:#0f4229; }

        /* ì»¨íŠ¸ë¡¤ ì˜ì—­ */
        .controls-section { display:grid; grid-template-columns:1fr 1fr; gap:5px; margin-bottom:5px; }
        .panel { background:#16213e; padding:8px; border-radius:6px; }
        .panel h2 { color:#00d9ff; font-size:.9em; margin-bottom:6px; padding-bottom:4px; border-bottom:2px solid #0f3460; }
        .btn { width:100%; padding:10px; font-size:.85em; font-weight:bold; border:none; border-radius:5px; cursor:pointer; transition:all .2s; margin:2px 0; }
        .btn:active { transform:scale(.95); }
        .btn:disabled { opacity:.4; cursor:not-allowed; }
        .btn-primary { background:#667eea; color:#fff; }
        .btn-success { background:#10b981; color:#fff; }
        .btn-danger { background:#ef4444; color:#fff; }
        .btn-warning { background:#f59e0b; color:#fff; }
        .btn-info { background:#06b6d4; color:#fff; }
        .btn-small { padding:6px; font-size:.75em; }

        .movement-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:3px; margin:5px 0; }
        .movement-btn { padding:15px 5px; font-size:1.2em; }
        .altitude-grid { display:grid; grid-template-columns:1fr 1fr; gap:3px; }
        .rotation-grid { display:grid; grid-template-columns:1fr 1fr; gap:3px; margin-top:5px; }

        #trackingStatus { padding:6px; margin:5px 0; background:#0f3460; border-radius:4px; font-size:.75em; text-align:center; }
        #trackingStatus.active { background:#0f4229; color:#6ee7b7; border:1px solid #10b981; }

        .log-section { background:#16213e; padding:8px; border-radius:6px; margin-bottom:5px; }
        .log-header { display:flex; justify-content:space-between; align-items:center; cursor:pointer; margin-bottom:5px; }
        .log-header h2 { color:#00d9ff; font-size:.9em; }
        .log-toggle { color:#00d9ff; font-size:1.2em; }
        #logContainer {
            overflow-y:auto; background:#0f3460; border-radius:4px; padding:6px; font-family:'Courier New', monospace; font-size:.65em;
            max-height:150px; transition:max-height .3s;
        }
        #logContainer.collapsed { max-height:0; padding:0; overflow:hidden; }
        .log-entry { padding:3px; margin-bottom:2px; border-radius:2px; border-left:2px solid; }
        .log-INFO { border-color:#3b82f6; color:#93c5fd; }
        .log-SUCCESS { border-color:#10b981; color:#6ee7b7; }
        .log-WARNING { border-color:#f59e0b; color:#fcd34d; }
        .log-ERROR { border-color:#ef4444; color:#fca5a5; }
        .log-DEBUG { border-color:#6b7280; color:#d1d5db; }
        .log-timestamp { font-weight:bold; margin-right:4px; }

        ::-webkit-scrollbar { width:6px; height:6px; }
        ::-webkit-scrollbar-track { background:#0f3460; }
        ::-webkit-scrollbar-thumb { background:#667eea; border-radius:3px; }

        @media (min-width:768px) {
            .container { padding:10px; max-width:1400px; margin:0 auto; }
            .main-layout { display:grid; grid-template-columns:1fr 400px; gap:10px; }
            .left-column { display:flex; flex-direction:column; gap:10px; }
            .right-column { display:flex; flex-direction:column; gap:10px; }
            .controls-section { display:flex; flex-direction:column; gap:10px; }
            #logContainer { max-height:300px; }
        }
        @media (max-width:480px) {
            .header { grid-template-columns:1fr; gap:5px; }
            h1 { text-align:center; }
            .status { order:2; }
            .header-controls { order:3; justify-content:center; }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>ğŸš Tello</h1>
        <div class="status">
            <div id="connectionStatus" class="status-item disconnected">â—</div>
            <div id="batteryStatus" class="status-item">ğŸ”‹ --</div>
            <div id="heightStatus" class="status-item">ğŸ“ --</div>
        </div>
        <div class="header-controls">
            <button class="header-btn header-btn-primary" onclick="connectTello()" id="connectBtn">ì—°ê²°</button>
            <button class="header-btn header-btn-warning" onclick="reconnectTello()" id="reconnectBtn" disabled>ì¬ì—°ê²°</button>
        </div>
    </div>

    <div class="main-layout">
        <div class="left-column">
            <!-- ë¹„ë””ì˜¤ ì˜ì—­ -->
            <div class="video-section">
                <div class="video-container" id="videoContainer">
                    <img id="videoFeed" src="/video_feed" alt="Video">

                    <!-- â–¶ ì‹ ê·œ: ì˜¤ë¥¸ìª½ ìœ„ ê¸°ëŠ¥ í† ê¸€/íˆ¬ëª…ë„ -->
                    <div class="feature-panel" id="featurePanel">
                        <div class="feature-title">
                            <span>ì‹œê°í™”/ì—°ì‚° í† ê¸€</span>
                            <span id="featureSyncDot" title="ì„œë²„ ë™ê¸°í™” ìƒíƒœ">â—</span>
                        </div>
                        <div class="feature-row">
                            <button id="btnPose" class="toggle" onclick="toggleFeature('pose')">Pose</button>
                            <button id="btnDepth" class="toggle" onclick="toggleFeature('depth')">Depth</button>
                            <button id="btnFlow" class="toggle" onclick="toggleFeature('flow')">Flow</button>
                        </div>
                        <div class="slider-wrap">
                            <input id="alphaSlider" type="range" min="0" max="100" step="5" value="50" oninput="updateAlpha(this.value)">
                            <span class="slider-badge" id="alphaBadge">íˆ¬ëª…ë„ 50%</span>
                        </div>
                        <div style="font-size:.7em; color:#94a3b8;">
                            OFF ì‹œ ì„œë²„ ì—°ì‚° ì™„ì „ ì¤‘ì§€ Â· ON ì‹œì—ë§Œ ê³„ì‚°/ì˜¤ë²„ë ˆì´ (Depth/Flow/Pose)
                        </div>
                    </div>
                </div>

                <div class="info-text">ğŸ’¡ ê°ì²´ í´ë¦­ â†’ ìë™ ì¶”ì  ì‹œì‘</div>

                <!-- ì¶”ì  ìƒíƒœ -->
                <div id="trackingStatus">ì¶”ì  ì•ˆ í•¨</div>

                <div class="detections-list">
                    <div id="detectionsContent" style="color:#94a3b8; text-align:center;">ê°ì§€ ëŒ€ê¸°ì¤‘...</div>
                </div>
            </div>

            <!-- ë¡œê·¸ -->
            <div class="log-section">
                <div class="log-header" onclick="toggleLog()">
                    <h2>ğŸ“‹ ë¡œê·¸</h2>
                    <span class="log-toggle" id="logToggle">â–¼</span>
                </div>
                <div id="logContainer"></div>
            </div>
        </div>

        <div class="right-column">
            <div class="controls-section">
                <div class="panel">
                    <h2>ê³ ë„</h2>
                    <div class="altitude-grid">
                        <button class="btn btn-info" onclick="sendCommand('up')" id="upBtn" disabled>â¬† ìƒìŠ¹</button>
                        <button class="btn btn-info" onclick="sendCommand('down')" id="downBtn" disabled>â¬‡ í•˜ê°•</button>
                    </div>
                </div>

                <div class="panel">
                    <h2>ë¹„í–‰</h2>
                    <button class="btn btn-success" onclick="sendCommand('takeoff')" id="takeoffBtn" disabled>ì´ë¥™ âœˆï¸</button>
                    <button class="btn btn-danger" onclick="sendCommand('land')" id="landBtn" disabled>ì°©ë¥™ ğŸ›¬</button>
                    <button class="btn btn-danger btn-small" onclick="sendCommand('emergency')" id="emergencyBtn" disabled>ê¸´ê¸‰!</button>
                </div>
            </div>

            <div class="panel">
                <h2>ì¡°ì¢…</h2>
                <div class="movement-grid">
                    <div></div>
                    <button class="btn btn-info movement-btn" onclick="sendCommand('forward')" id="forwardBtn" disabled>â†‘</button>
                    <div></div>
                    <button class="btn btn-info movement-btn" onclick="sendCommand('left')" id="leftBtn" disabled>â†</button>
                    <div></div>
                    <button class="btn btn-info movement-btn" onclick="sendCommand('right')" id="rightBtn" disabled>â†’</button>
                    <div></div>
                    <button class="btn btn-info movement-btn" onclick="sendCommand('back')" id="backBtn" disabled>â†“</button>
                    <div></div>
                </div>
                <div class="rotation-grid">
                    <button class="btn btn-info btn-small" onclick="sendCommand('ccw')" id="ccwBtn" disabled>â†º ì¢ŒíšŒì „</button>
                    <button class="btn btn-info btn-small" onclick="sendCommand('cw')" id="cwBtn" disabled>â†» ìš°íšŒì „</button>
                </div>
            </div>

            <div class="panel">
                <button class="btn btn-danger" onclick="stopTracking()" id="stopTrackingBtn" style="display:none;">ğŸ›‘ ì¶”ì  ì¤‘ì§€</button>
            </div>

            <div class="panel">
                <h2>ë„ë‘‘ ID ìˆ˜ë™ ì§€ì • & ì¢…ë£Œ</h2>
                <div style="display:grid; grid-template-columns:1fr auto; gap:6px; margin-bottom:6px;">
                    <input id="manualId" type="number" min="1" placeholder="identity_id ì…ë ¥" style="width:100%; padding:6px;">
                    <button class="btn btn-primary btn-small" onclick="manualSetThief()">ì§€ì •&ì¶”ì </button>
                </div>
                <button class="btn btn-danger" onclick="shutdownServer()">âœ”ï¸ ì„œë²„ ì¢…ë£Œ (CTRL+C)</button>
            </div>
        </div>
    </div>
</div>

<script>
/* ---------------- Socket.IO ---------------- */
const socket = io({ transports: ['websocket','polling'] });

/* ---------------- UI state ---------------- */
let selectedTarget = null;
let isTracking = false;
let currentDetections = [];
let logCollapsed = false;

/* â–¶ ì‹ ê·œ: ê¸°ëŠ¥ í† ê¸€ ìƒíƒœ (í´ë¼ì´ì–¸íŠ¸ ìºì‹œ) */
let features = { depth:false, pose:false, flow:false, alpha:0.5 };

const videoFeed = document.getElementById('videoFeed');
const btnPose = document.getElementById('btnPose');
const btnDepth = document.getElementById('btnDepth');
const btnFlow = document.getElementById('btnFlow');
const alphaSlider = document.getElementById('alphaSlider');
const alphaBadge = document.getElementById('alphaBadge');
const syncDot = document.getElementById('featureSyncDot');

/* ---------------- ìœ í‹¸ ---------------- */
function toIntOrNull(v) {
    if (v === null || v === undefined) return null;
    if (v === 'null' || v === 'undefined') return null;
    const n = Number(v);
    return Number.isFinite(n) ? Math.trunc(n) : null;
}
function addLog(level, message, timestamp) {
    const logContainer = document.getElementById('logContainer');
    const logEntry = document.createElement('div');
    logEntry.className = `log-entry log-${level}`;
    const ts = timestamp || new Date().toTimeString().split(' ')[0];
    logEntry.innerHTML = `<span class="log-timestamp">[${ts}]</span>${message}`;
    logContainer.appendChild(logEntry);
    logContainer.scrollTop = logContainer.scrollHeight;
    while (logContainer.children.length > 50) logContainer.removeChild(logContainer.firstChild);
}
function toggleLog() {
    const logContainer = document.getElementById('logContainer');
    const toggle = document.getElementById('logToggle');
    logCollapsed = !logCollapsed;
    if (logCollapsed) { logContainer.classList.add('collapsed'); toggle.textContent = 'â–¶'; }
    else { logContainer.classList.remove('collapsed'); toggle.textContent = 'â–¼'; }
}
function setSyncState(ok) {
    syncDot.style.color = ok ? '#10b981' : '#ef4444';
    syncDot.title = ok ? 'ì„œë²„ì™€ ë™ê¸°í™”ë¨' : 'ì„œë²„ ë¯¸ë™ê¸°í™”';
}

/* ---------------- ì‹ ê·œ: í† ê¸€ UI/ì†¡ì‹  ---------------- */
function applyFeatureButtons() {
    btnPose.classList.toggle('on', features.pose);
    btnDepth.classList.toggle('on', features.depth);
    btnFlow.classList.toggle('on', features.flow);
    alphaSlider.value = Math.round(features.alpha * 100);
    alphaBadge.textContent = `íˆ¬ëª…ë„ ${Math.round(features.alpha * 100)}%`;
}
function emitFeatures() {
    setSyncState(false);
    socket.emit('set_features', {
        depth: !!features.depth,
        pose:  !!features.pose,
        flow:  !!features.flow,
        alpha: Number(features.alpha) || 0.5,
    });
}
function toggleFeature(key) {
    features[key] = !features[key];
    applyFeatureButtons();
    emitFeatures();
}
function updateAlpha(val) {
    const v = Math.max(0, Math.min(100, Number(val)));
    features.alpha = v / 100.0;
    alphaBadge.textContent = `íˆ¬ëª…ë„ ${v}%`;
    emitFeatures();
}

/* ---------------- ë¹„ë””ì˜¤ í´ë¦­(ê°ì²´ ì„ íƒ) ---------------- */
document.getElementById('videoContainer').addEventListener('click', function (e) {
    if (!currentDetections || currentDetections.length === 0) return;
    const rect = videoFeed.getBoundingClientRect();
    const nw = videoFeed.naturalWidth || rect.width;
    const nh = videoFeed.naturalHeight || rect.height;
    const scaleX = nw / rect.width;
    const scaleY = nh / rect.height;
    const clickX = (e.clientX - rect.left) * scaleX;
    const clickY = (e.clientY - rect.top) * scaleY;
    for (let det of currentDetections) {
        const [x1,y1,x2,y2] = det.bbox;
        if (clickX >= x1 && clickX <= x2 && clickY >= y1 && clickY <= y2) {
            const iid = toIntOrNull(det.identity_id);
            if (iid === null || iid <= 0) {
                addLog('WARNING','IDê°€ ì—†ëŠ”(??) ê°ì²´ëŠ” ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê°¤ëŸ¬ë¦¬ 2ì¥ í™•ì • í›„ ì‹œë„í•˜ì„¸ìš”.');
                return;
            }
            selectTargetAndStartTracking(det);
            highlightClickedTarget(det, rect, scaleX, scaleY);
            break;
        }
    }
});
function highlightClickedTarget(det, rect, scaleX, scaleY) {
    const [x1,y1,x2,y2] = det.bbox;
    const displayX = x1 / scaleX;
    const displayY = y1 / scaleY;
    const displayW = (x2 - x1) / scaleX;
    const displayH = (y2 - y1) / scaleY;
    const overlay = document.createElement('div');
    overlay.className = 'click-target';
    overlay.style.left = displayX + 'px';
    overlay.style.top = displayY + 'px';
    overlay.style.width = displayW + 'px';
    overlay.style.height = displayH + 'px';
    document.getElementById('videoContainer').appendChild(overlay);
    setTimeout(() => overlay.remove(), 1000);
}

/* ---------------- ì†Œì¼“ ìˆ˜ì‹  ---------------- */
socket.on('connect', () => {
    addLog('SUCCESS', 'ì„œë²„ ì—°ê²°');
    socket.emit('get_tello_status');
    /* â–¶ ì„œë²„ì— í˜„ì¬ ê¸°ëŠ¥ ìƒíƒœ ìš”ì²­(ìˆìœ¼ë©´) */
    socket.emit('get_features'); // ì„œë²„ê°€ ì—†ìœ¼ë©´ ë¬´ì‹œë¨
});

socket.on('log_message', (data) => addLog(data.level, data.message, data.timestamp));

socket.on('tello_status', (data) => {
    const statusEl = document.getElementById('connectionStatus');
    if (data.connected) {
        statusEl.textContent = 'â— ON';
        statusEl.className = 'status-item connected';
        document.getElementById('batteryStatus').textContent = `ğŸ”‹ ${data.battery}%`;
        enableControls(true);
        const r = document.getElementById('reconnectBtn'); if (r) r.disabled = false;
        addLog('SUCCESS', `ì—°ê²°! ë°°í„°ë¦¬ ${data.battery}%`);
    } else {
        statusEl.textContent = 'â— OFF';
        statusEl.className = 'status-item disconnected';
        enableControls(false);
        addLog('ERROR', 'ì—°ê²° ì‹¤íŒ¨');
    }
});

/* â–¶ ì„œë²„ê°€ ë¸Œë¡œë“œìºìŠ¤íŠ¸í•´ì£¼ëŠ” ê¸°ëŠ¥ ìƒíƒœ ìˆ˜ì‹  */
socket.on('feature_status', (data) => {
    try {
        features.depth = !!data.depth;
        features.pose  = !!data.pose;
        features.flow  = !!data.flow;
        if (typeof data.alpha === 'number') features.alpha = Math.max(0, Math.min(1, data.alpha));
        applyFeatureButtons();
        setSyncState(true);
        addLog('INFO', `í† ê¸€ ìƒíƒœ ë™ê¸°í™” â†’ depth:${features.depth} pose:${features.pose} flow:${features.flow} alpha:${(features.alpha*100)|0}%`);
    } catch(e) { /* noop */ }
});

socket.on('detections_update', (data) => {
    currentDetections = data?.detections || [];
    document.getElementById('batteryStatus').textContent = `ğŸ”‹ ${data.battery}%`;
    document.getElementById('heightStatus').textContent = `ğŸ“ ${data.height}cm`;
    updateDetectionsList(currentDetections);
    if (typeof data.is_tracking === 'boolean') updateTrackingStatus(data.is_tracking);
});
socket.on('stream_error', (data) => addLog('ERROR', data.message));
socket.on('command_response', (data) => addLog(data.success ? 'SUCCESS' : 'ERROR', data.message));
socket.on('tracking_status', (data) => {
    if (data.is_tracking) {
        addLog('SUCCESS', `ì„œë²„ ì¶”ì  ON: ID ${data.target_identity_id}`);
        isTracking = true;
    } else {
        addLog('WARNING', data.message || 'ì„œë²„ ì¶”ì  OFF/ì‹¤íŒ¨');
        isTracking = false;
    }
    updateTrackingStatus(isTracking);
});

/* ---------------- ì†Œì¼“ ì†¡ì‹  ---------------- */
function connectTello() {
    addLog('INFO', 'Tello ì—°ê²°ì¤‘...'); socket.emit('connect_tello'); document.getElementById('connectBtn').disabled = true;
}
function reconnectTello() { addLog('INFO', 'Tello ì¬ì—°ê²°ì¤‘...'); socket.emit('reconnect_tello'); }
function sendCommand(command) { socket.emit('send_command', { command }); }
function shutdownServer() { addLog('WARNING', 'ì„œë²„ ì¢…ë£Œ ìš”ì²­â€¦'); socket.emit('shutdown_server'); }

/* ---------------- ë¦¬ìŠ¤íŠ¸ ë Œë” ---------------- */
function updateDetectionsList(detections) {
    const container = document.getElementById('detectionsContent');
    if (!detections || detections.length === 0) {
        container.innerHTML = '<span style="color:#94a3b8;">ê°ì§€ ëŒ€ê¸°ì¤‘...</span>'; return;
    }
    container.innerHTML = '';
    detections.forEach((det) => {
        const item = document.createElement('div');
        item.className = 'detection-item';
        const iid = toIntOrNull(det.identity_id);
        const same = !!selectedTarget && selectedTarget.identity_id === iid;
        if (isTracking && same) item.className += ' tracking';
        else if (same) item.className += ' selected';
        const label = (iid === null) ? '??' : iid;
        item.innerHTML = `<strong>ID ${label}</strong>: ${det.class} <span style="opacity:.7;">${(det.confidence * 100).toFixed(0)}%</span>`;
        if (iid === null || iid <= 0) { 
            item.style.opacity = .55;
            item.style.cursor = 'not-allowed';
            item.title = 'ID(??) í•­ëª©ì€ ì„ íƒ ë¶ˆê°€ â€” ê°¤ëŸ¬ë¦¬ 2ì¥ ì €ì¥ í›„ IDê°€ ë¶€ì—¬ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.';
        } else {
            item.onclick = () => selectTargetAndStartTracking(det);
        }
        container.appendChild(item);
    });
}

/* ---------------- ì„ íƒ + ì¶”ì  ì‹œì‘ ---------------- */
function selectTargetAndStartTracking(detection) {
    const iid = toIntOrNull(detection.identity_id);
    if (iid === null || iid <= 0) {
        addLog('WARNING','IDê°€ ì—†ëŠ”(??) ê°ì²´ëŠ” ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    selectedTarget = { ...detection, identity_id: iid };
    addLog('INFO', `íƒ€ê²Ÿ: ID ${iid ?? '??'} (${detection.class})`);
    socket.emit('set_target', { target_identity_id: iid, class: detection.class, bbox: detection.bbox });
    socket.emit('start_tracking');
    updateDetectionsList(currentDetections);
}

/* ---------------- ìƒíƒœ/ë²„íŠ¼ ---------------- */
function updateTrackingStatus(tracking) {
    isTracking = !!tracking;
    const statusEl = document.getElementById('trackingStatus');
    const stopBtn = document.getElementById('stopTrackingBtn');
    if (isTracking && selectedTarget) {
        statusEl.textContent = `ğŸ¯ ì¶”ì ì¤‘: ID ${selectedTarget.identity_id ?? '??'} (${selectedTarget.class})`;
        statusEl.className = 'active'; stopBtn.style.display = 'block';
    } else {
        statusEl.textContent = 'ì¶”ì  ì•ˆ í•¨'; statusEl.className = ''; stopBtn.style.display = 'none';
    }
}
function stopTracking() { addLog('INFO', 'ì¶”ì  ì¤‘ì§€'); socket.emit('stop_tracking'); }
function manualSetThief() {
    const v = toIntOrNull(document.getElementById('manualId').value);
    if (v === null || v <= 0) { addLog('WARNING','ìœ íš¨í•œ identity_idë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
    selectedTarget = { identity_id:v, class:'person', bbox:null };
    socket.emit('set_target', { target_identity_id:v, class:'person', bbox:null });
    socket.emit('start_tracking');
}
function enableControls(enabled) {
    ['reconnectBtn','takeoffBtn','landBtn','emergencyBtn','forwardBtn','backBtn','leftBtn','rightBtn','upBtn','downBtn','cwBtn','ccwBtn']
        .forEach(id => { const el = document.getElementById(id); if (el) el.disabled = !enabled; });
}

/* ---------------- ë¶€íŒ… ë¡œê·¸ ---------------- */
window.onload = () => {
    addLog('INFO', 'ì‹œìŠ¤í…œ ì¤€ë¹„');
    applyFeatureButtons(); // ì´ˆê¸° UI ë°˜ì˜
};
</script>
</body>
</html>
